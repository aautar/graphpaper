"use strict";var _slicedToArray=function(){function a(c,d){var e=[],f=!0,g=!1,h=void 0;try{for(var l,k=c[Symbol.iterator]();!(f=(l=k.next()).done)&&(e.push(l.value),!(d&&e.length===d));f=!0);}catch(m){g=!0,h=m}finally{try{!f&&k["return"]&&k["return"]()}finally{if(g)throw h}}return e}return function(c,d){if(Array.isArray(c))return c;if(Symbol.iterator in Object(c))return a(c,d);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();(function(){"use strict";function a(m,n){this.__x=m,this.__y=n}function c(m,n){this.getType=function(){return m},this.getIntersectionPoint=function(){return n}}function d(m,n){this.__startPoint=m,this.__endPoint=n}function e(m){var n=this,o=[];this.push=function(q){for(var r=0;r<o.length;r++)if(q.isEqual(o[r]))return!1;return o.push(q),!0},this.findPointClosestTo=function(q){var r=null,s=Number.MAX_SAFE_INTEGER;return o.forEach(function(t){var u=new d(q,t);u.getLength()<s&&(r=t,s=u.getLength())}),r},this.findDistanceToPointClosestTo=function(q){var r=Number.MAX_SAFE_INTEGER;return o.forEach(function(s){var t=new d(q,s);t.getLength()<r&&(r=t.getLength())}),r},this.findPointsCloseTo=function(q,r){var s=new e;return o.forEach(function(t){var u=new d(q,t);u.getLength()<=r&&s.push(t)}),s},this.toArray=function(){return o},this.toFloat64Array=function(){for(var q=new Float64Array(2*o.length),r=0;r<o.length;r++)q[0+2*r]=o[r].getX(),q[1+2*r]=o[r].getY();return q};this.count=function(){return o.length},m&&Array.isArray(m)?m.forEach(n.push):m&&"[object Float64Array]"===Object.prototype.toString.call(m)&&function p(q){o.length=0;for(var r=0;r<q.length;r+=2)o.push(new a(q[r],q[r+1]))}(m)}function f(m){var n=this,o=[];this.push=function(q){var r=!1;return(o.forEach(function(s){q.isEqual(s)&&(r=!0)}),!r)&&(o.push(q),!0)},this.toArray=function(){return o},this.count=function(){return o.length},this.toFloat64Array=function(){for(var q=new Float64Array(4*o.length),r=0;r<o.length;r++)q[0+4*r]=o[r].getStartPoint().getX(),q[1+4*r]=o[r].getStartPoint().getY(),q[2+4*r]=o[r].getEndPoint().getX(),q[3+4*r]=o[r].getEndPoint().getY();return q};m&&Array.isArray(m)?m.forEach(n.push):m&&"[object Float64Array]"===Object.prototype.toString.call(m)&&function p(q){o.length=0;for(var r=0;r<q.length;r+=4)o.push(new d(new a(q[r],q[r+1]),new a(q[r+2],q[r+3])))}(m)}function g(m,n){var o=this,p=n.toArray(),q=new Map,r=function(v){for(var x,w=0;w<p.length;w++)if(x=p[w].computeIntersectionType(v),x===h.LINESEG)return!0;return!1},t=function(v){var w=Number.MAX_SAFE_INTEGER,x=null,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var B,A=v.entries()[Symbol.iterator]();!(_iteratorNormalCompletion=(B=A.next()).done);_iteratorNormalCompletion=!0){var _step$value=_slicedToArray(B.value,2),y=_step$value[0],z=_step$value[1];z<w&&(x=y,w=z)}}catch(C){_didIteratorError=!0,_iteratorError=C}finally{try{!_iteratorNormalCompletion&&A.return&&A.return()}finally{if(_didIteratorError)throw _iteratorError}}return null===x?null:{cost:w,point:x}},u=function(v,w,x,y){var A=new Map,z=q.get(x);z=z.filter(function(C){for(var D=0;D<w.length;D++)if(C.isEqual(w[D]))return!1;return!0}),z.forEach(function(C){var D=new d(x,C).getLength()+v,E=new d(C,y).getLength();A.set(C,D+E)});var B=t(A);return null===B?null:B};this.findPointClosestTo=function(v){var w=null,x=Number.MAX_SAFE_INTEGER;return q.forEach(function(y,z){var A=new d(v,z);A.getLength()<x&&(w=z,x=A.getLength())}),w},this.findVisiblePointClosestTo=function(v){var w=null,x=Number.MAX_SAFE_INTEGER;return q.forEach(function(y,z){var A=new d(v,z);!r(A)&&A.getLength()<x&&(w=z,x=A.getLength())}),w},this.computeRoute=function(v,w){var z=o.findVisiblePointClosestTo(v);if(null===z)return new e;for(var B,x=0,A=[z],y=z;(B=u(x,A,y,w),null!==B)&&!(x+=new d(y,B.point).getLength(),A.push(B.point),y=B.point,1>new d(y,w).getLength()););return new e(A)},function s(){for(var v=m.toArray(),w=0;w<v.length;w++)q.set(v[w],[]);for(var x=0;x<v.length;x++)for(var z,y=x+1;y<v.length;y++)if(z=new d(v[x],v[y]),!r(z)){var A=q.get(v[x]);A.push(v[y]),q.set(v[x],A);var B=q.get(v[y]);B.push(v[x]),q.set(v[y],B)}}()}a.prototype.getX=function(){return this.__x},a.prototype.getY=function(){return this.__y},a.prototype.isEqual=function(m){return this.__x===m.getX()&&this.__y===m.getY()},a.prototype.getCartesianPoint=function(m,n){return new a(this.__x-0.5*m,-this.__y+0.5*n)},a.prototype.toString=function(){return this.__x+" "+this.__y};var h=Object.freeze({PARALLEL:"parallel",COINCIDENT:"coincident",LINE:"line",LINESEG:"lineseg"});d.prototype.getStartPoint=function(){return this.__startPoint},d.prototype.getEndPoint=function(){return this.__endPoint},d.prototype.isEqual=function(m){return this.getStartPoint().isEqual(m.getStartPoint())&&this.getEndPoint().isEqual(m.getEndPoint())},d.prototype.getLength=function(){return Math.sqrt(Math.pow(this.__endPoint.getX()-this.__startPoint.getX(),2)+Math.pow(this.__endPoint.getY()-this.__startPoint.getY(),2))},d.prototype.computeIntersectionType=function(m){var n=this.__startPoint.getX(),o=this.__startPoint.getY(),p=this.__endPoint.getX(),q=this.__endPoint.getY(),r=m.getStartPoint().getX(),s=m.getStartPoint().getY(),t=m.getEndPoint().getX(),u=m.getEndPoint().getY(),v=(u-s)*(p-n)-(t-r)*(q-o),w=(t-r)*(o-s)-(u-s)*(n-r),x=(p-n)*(o-s)-(q-o)*(n-r);if(0==v)return 0==v&&0==w&&0==x?h.COINCIDENT:h.PARALLEL;var y=w/v,z=x/v;return 1<y||0>y||1<z||0>z?h.LINE:h.LINESEG},d.prototype.computeIntersection=function(m){var n=this.__startPoint.getX(),o=this.__startPoint.getY(),p=this.__endPoint.getX(),q=this.__endPoint.getY(),r=m.getStartPoint().getX(),s=m.getStartPoint().getY(),t=m.getEndPoint().getX(),u=m.getEndPoint().getY(),v=(u-s)*(p-n)-(t-r)*(q-o),w=(t-r)*(o-s)-(u-s)*(n-r),x=(p-n)*(o-s)-(q-o)*(n-r);if(0==v)return 0==v&&0==w&&0==x?new c(h.COINCIDENT,null):new c(h.PARALLEL,null);var y=w/v,z=x/v,A=_startPoint.getX()+y*(_endPoint.getX()-_startPoint.getX()),B=_startPoint.getY()+y*(_endPoint.getY()-_startPoint.getY());return 1<y||0>y||1<z||0>z?new c(h.LINE,new a(A,B)):new c(h.LINESEG,new a(A,B))};var k=function(m){return"L"+m.getX()+" "+m.getY()},l=function(m,n,o){var p=m.anchor_start_centroid.split(" "),q=m.anchor_end_centroid.split(" "),r=new a(p[0],p[1]),s=new a(q[0],q[1]),t=n.findDistanceToPointClosestTo(r),u=n.findPointsCloseTo(r,t).findPointClosestTo(s),v=n.findPointsCloseTo(s,t).findPointClosestTo(r),w=o.computeRoute(u,v),x=w.toArray(),y=[];x.forEach(function(B){y.push(k(B))}),y.push(k(s));var z=r.getX()+" "+r.getY(),A="M"+z+y.join(" ");return A};onmessage=function onmessage(m){var n={overallTime:null},o=new Date,p=m.data.gridSize,q=m.data.connectorDescriptors,r=m.data.routingPoints,s=new Float64Array(r),t=new e(s),u=m.data.boundaryLines,v=new Float64Array(u),w=new f(v),x=m.data.anchorPoints,y=new Float64Array(x),z=new e(y),A=new g(t,w);q.forEach(function(B){B.svgPath=l(B,z,A)}),n.overallTime=new Date-o,postMessage({connectorDescriptors:q,metrics:n})}})();